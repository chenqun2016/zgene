<!-- <picture id="splash">
  <source
    srcset="splash/img/light-1x.png 1x, splash/img/light-2x.png 2x, splash/img/light-3x.png 3x, splash/img/light-4x.png 4x"
    media="(prefers-color-scheme: light) or (prefers-color-scheme: no-preference)">
  <source
    srcset="splash/img/dark-1x.png 1x, splash/img/dark-2x.png 2x, splash/img/dark-3x.png 3x, splash/img/dark-4x.png 4x"
    media="(prefers-color-scheme: dark)">
  <img class="center" src="splash/img/light-1x.png" />
</picture> -->
<!DOCTYPE html>
<html>

<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base
  -->
  <base href="/webapp/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="zgene">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <title>Z基因 - 遇见微观的自己，越探索·越幸福 - 越探索·越健康</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" type="text/css" href="splash/style.css">
</head>

<body
  style="position: fixed; inset: 0px; overflow: hidden; padding: 0px; margin: 0px; user-select: none; touch-action: none; font: 14px sans-serif; color: red;">
  <!-- This script installs service_worker.js to provide PWA functionality to
       application. For more information, see:
       https://developers.google.com/web/fundamentals/primers/service-workers -->
  <script src="js/vconsole.min.js"></script>
  <script>
    // 测试环境开启调试
    if (window.location.host == "test.z-gene.cn") {
      const vConsole = new VConsole();
    }
  </script>
  <script src="//cdn.jsdelivr.net/npm/jsqr@1.3.1/dist/jsQR.min.js"></script>
  <script src="//res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
  <script>
    var inWechatWeb = false;
    var inWechatMini = false; // 是否是微信小程序

    // GetCookie 获取Cookie
    function GetCookie(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    var ua = navigator.userAgent.toLowerCase();
    window.onload = function () {
      if (ua.match(/MicroMessenger/i) == "micromessenger") {
        inWechatWeb = true;
      } else {
        inWechatWeb = false;
      }
    };

    let useHtml = true;
    if (ua.match(/iPhone OS 15/i) == "iphone os 15") {
      // 如果是IOS15，则采用canvaskit，否则无法打开
      // HTMLCanvasElement.prototype.getContext = function (orig) {
      //   return function (type) {
      //     return type !== "webgl2" ? orig.apply(this, arguments) : null
      //   }
      // }(HTMLCanvasElement.prototype.getContext)
    }

    if (ua.match(/miniProgram/i) == "miniprogram") {
      // 通过UA判断小程序
      inWechatMini = true;
    }

    if (useHtml) {
      window.flutterWebRenderer = "html";
    } else {
      window.flutterWebRenderer = "canvaskit";
    }

    var isShowing = false;

    function showToast(msg, time = 3000) {
      var outDiv = document.createElement("div")
      outDiv.style.position = "absolute";
      outDiv.style.marginTop = "70%";
      outDiv.style.zIndex = 99999;
      outDiv.style.left = 0;
      outDiv.style.right = 0;
      outDiv.style.textAlign = "center";
      outDiv.innerHTML = `<div style="background: #E6F2FF;border-radius: 8px;color: #1877F2;padding: 8px;margin: auto;display: inline-block;">${msg}</div>`;

      if (isShowing) {
        return
      }

      document.querySelector("body").append(outDiv);
      isShowing = true;

      setTimeout(function () {
        outDiv.remove();
        isShowing = false;
      }, time);
    }

    function InWechatWeb() {
      return inWechatWeb;
    }

    function InWechatMini() {
      return inWechatMini;
    }

    function JumpLogin() {
      location.href = "/wechat/login";
    }

    var serviceWorkerVersion = null;
    var scriptLoaded = false;
    function loadMainDartJs() {
      if (scriptLoaded) {
        return;
      }
      scriptLoaded = true;
      var scriptTag = document.createElement('script');
      scriptTag.src = 'main.dart.js';
      scriptTag.type = 'application/javascript';
      document.body.append(scriptTag);
    }

    function WeixinPay(parms) {
      let res = JSON.parse(parms);
      if (inWechatMini) {
        let tmp = encodeURIComponent(JSON.stringify({
          timeStamp: res["timeStamp"],
          nonceStr: res["nonceStr"],
          package: res["package"],
          paySign: res["paySign"],
        }));
        // console.log("[WeixinPay]tmp=",tmp);
        // 在小程序里面支付
        wx.miniProgram.redirectTo({ url: `/pages/pay/index?parms=${tmp}` });
      } else if (inWechatWeb) {
        // 微信web支付
        WeixinJSBridge.invoke(
          'getBrandWCPayRequest', {
          "appId": res["appid"],     //公众号ID，由商户传入
          "timeStamp": `${res["timestamp"]}`,         //时间戳，自1970年以来的秒数
          "nonceStr": res["noncestr"], //随机串
          "package": res["package"],
          "signType": "RSA",         //微信签名方式：
          "paySign": res["sign"] //微信签名
        },
          function (res) {
            if (res.err_msg == "get_brand_wcpay_request:ok") {
              // 使用以上方式判断前端返回,微信团队郑重提示：
              //res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
              // alert("ok");
              location.href = "/webapp/#/push_order_page";
            }
          });
      }
      // WeixinJSBridge.invoke(
      //   'getBrandWCPayRequest', {
      //   "appId": res["appid"],     //公众号ID，由商户传入
      //   "timeStamp": res["timestamp"],         //时间戳，自1970年以来的秒数
      //   "nonceStr": res["noncestr"], //随机串
      //   "package": res["package"],
      //   "signType": "RSA",         //微信签名方式：
      //   "paySign": res["sign"] //微信签名
      // },
      //   function (res) {
      //     if (res.err_msg == "get_brand_wcpay_request:ok") {
      //       // 使用以上方式判断前端返回,微信团队郑重提示：
      //       //res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
      //       // alert("ok");
      //       location.href = "/webapp/#/my_order";
      //     }
      //   });
    }



    if ('serviceWorker' in navigator) {
      // Service workers are supported. Use them.
      window.addEventListener('load', function () {
        // Wait for registration to finish before dropping the <script> tag.
        // Otherwise, the browser will load the script multiple times,
        // potentially different versions.
        var serviceWorkerUrl = 'flutter_service_worker.js?v=' + serviceWorkerVersion;
        navigator.serviceWorker.register(serviceWorkerUrl)
          .then((reg) => {
            function waitForActivation(serviceWorker) {
              serviceWorker.addEventListener('statechange', () => {
                if (serviceWorker.state == 'activated') {
                  console.log('Installed new service worker.');
                  loadMainDartJs();
                }
              });
            }
            if (!reg.active && (reg.installing || reg.waiting)) {
              // No active web worker and we have installed or are installing
              // one for the first time. Simply wait for it to activate.
              if (typeof reg.installing !== "undefined") {
                waitForActivation(reg.installing);
              } else {
                waitForActivation(reg.waiting);
              }
            } else if (!reg.active.scriptURL.endsWith(serviceWorkerVersion)) {
              // When the app updates the serviceWorkerVersion changes, so we
              // need to ask the service worker to update.
              console.log('New service worker available.');
              reg.update();
              waitForActivation(reg.installing);
            } else {
              // Existing service worker is still good.
              console.log('Loading app from service worker.');
              loadMainDartJs();
            }
          });

        // If service worker doesn't succeed in a reasonable amount of time,
        // fallback to plaint <script> tag.
        setTimeout(() => {
          if (!scriptLoaded) {
            console.warn(
              'Failed to load app from service worker. Falling back to plain <script> tag.',
            );
            loadMainDartJs();
          }
        }, 4000);
      });
    } else {
      // Service workers not supported. Just drop the <script> tag.
      loadMainDartJs();
    }

    // 微信小程序
    wx.miniProgram.getEnv(function (res) {
      console.log("WeixinJSBridgeReady ready");
      console.log(res.miniprogram) // true
      setTimeout(function () {
        console.log("postMessage");
        wx.miniProgram.navigateBack({ delta: 1 })
        wx.miniProgram.postMessage({
          data: JSON.stringify({
            action: 'vibrateShort',
          })
        });
      }, 5000);
    })

    setTimeout(function () {
      // 支持调用flutter内的方法
      if (typeof window.helloDart !== "undefined") {
        window.helloDart();
      }

    }, 5000);
  </script>
  <picture id="splash">
    <source srcset="splash/img/light-1x.png 1x, splash/img/light-2x.png 2x, splash/img/light-3x.png 3x, splash/img/light-4x.png 4x" media="(prefers-color-scheme: light) or (prefers-color-scheme: no-preference)">
    <source srcset="splash/img/dark-1x.png 1x, splash/img/dark-2x.png 2x, splash/img/dark-3x.png 3x, splash/img/dark-4x.png 4x" media="(prefers-color-scheme: dark)">
    <img class="center" src="splash/img/light-1x.png" />
  </picture>
</body>

</html>